<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPL Workout Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Slate Gray & Royal Blue -->
    <!-- Application Structure Plan: The application is structured as a single-page dashboard. The primary navigation consists of day-selector tabs (Mon-Sat) allowing the user to switch between workouts instantly. The main content area dynamically renders the selected day's workout plan, with interactive input fields for logging weight and reps for each set. This structure was chosen for its simplicity and task-oriented design, enabling the user to quickly access and log their daily workout without navigating away from the main view. Data is persisted in the browser's localStorage for a seamless experience. -->
    <!-- Visualization & Content Choices: The core report content (workout exercises, sets, reps) is presented in clear, interactive tables. Goal: Track workout progress. Method: Interactive HTML tables with input fields and checkboxes. Interaction: Users can type their weight/reps and check off completed sets. Justification: This direct manipulation method is the most intuitive and efficient way for a user to log workout data. It's more effective than static text as it provides immediate feedback and a sense of accomplishment. Library/Method: Vanilla JavaScript for DOM manipulation and state management. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .day-tab.active { background-color: #3b82f6; color: white; }
        .set-row.completed td { color: #9ca3af; }
        .set-row.completed input { text-decoration: line-through; color: #9ca3af; }
        .completed-workout-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            flex-direction: column;
            backdrop-filter: blur(4px);
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto max-w-4xl p-4 sm:p-6">
        <header class="text-center mb-6">
                    <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">Foundational PPL Plan</h1>
                    <p id="subtitle-display" class="text-slate-500 mt-1">Your 8-Week Foundational Block - Week 1</p>
                </header>

                <div class="flex justify-between items-center bg-white rounded-lg shadow-md p-3 mb-4">
                    <button id="prev-week-btn" class="px-4 py-2 bg-slate-200 rounded-md hover:bg-slate-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">◄ Prev</button>
                    
                    <h2 class="text-center">
                        <span id="week-number-display" class="text-xl font-bold text-slate-700"></span>
                        <span id="week-date-display" class="text-sm font-normal text-slate-500 ml-1"></span>
                    </h2>

                    <button id="next-week-btn" class="px-4 py-2 bg-slate-200 rounded-md hover:bg-slate-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Next ►</button>
                </div>        
        <nav class="bg-white rounded-lg shadow-md p-2 mb-6">
            <div id="day-selector" class="grid grid-cols-3 sm:grid-cols-6 gap-2">
                </div>
        </nav>

        <nav class="bg-white rounded-lg shadow-md p-2 mb-6">
            <div id="day-selector" class="grid grid-cols-3 sm:grid-cols-6 gap-2">
                <!-- Day tabs will be inserted here by JavaScript -->
            </div>
        </nav>

        <main id="workout-container" class="space-y-6">
            <!-- Workout content will be inserted here by JavaScript -->
        </main>
        
        <footer class="text-center mt-8 text-slate-400 text-sm">
            <p>Remember to log your lifts and focus on progressive overload!</p>
        </footer>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyBlb1ZQxdIl3qRdGErAnxa2i69Y1a16-Btst_lE-gIU4lfYzSR3C8M-ruV6KXRTs1H/exec';

        const workoutData = {
                    monday: {
                        name: "Push Day",
                        exercises: [
                            { name: "Barbell Bench Press", sets: 3, effort: "Heavy (5-8 reps)", rest: "2-3 minutes", logs: Array.from({ length: 3 }, () => ({ weight: '', reps: '', done: false })) },
                            { name: "Seated Dumbbell Overhead Press", sets: 3, effort: "Moderate (8-12 reps)", rest: "90 seconds", logs: Array.from({ length: 3 }, () => ({ weight: '', reps: '', done: false })) },
                            { name: "Incline Dumbbell Press", sets: 3, effort: "Moderate (8-12 reps)", rest: "90 seconds", logs: Array.from({ length: 3 }, () => ({ weight: '', reps: '', done: false })) },
                            { name: "Dumbbell Lateral Raises", sets: 4, effort: "Light (12-15 reps)", rest: "60 seconds", logs: Array.from({ length: 4 }, () => ({ weight: '', reps: '', done: false })) },
                            { name: "Triceps Rope Extension", sets: 4, effort: "Moderate (10-15 reps)", rest: "60 seconds", logs: Array.from({ length: 4 }, () => ({ weight: '', reps: '', done: false })) },
                        ],
                        extra: { type: "Cardio", details: "30 minutes of Low-Intensity Steady State (LISS)" }
                    },
                    tuesday: {
                        name: "Pull Day",
                        exercises: [
                            { name: "Pull-ups (or Lat Pulldowns)", sets: 3, effort: "Heavy (6-10 reps)", rest: "2-3 minutes", logs: Array.from({ length: 3 }, () => ({ weight: '', reps: '', done: false })) },
                            { name: "Barbell Rows", sets: 3, effort: "Heavy (6-10 reps)", rest: "2-3 minutes", logs: Array.from({ length: 3 }, () => ({ weight: '', reps: '', done: false })) },
                            { name: "Face Pulls", sets: 4, effort: "Light (15-20 reps)", rest: "60 seconds", logs: Array.from({ length: 4 }, () => ({ weight: '', reps: '', done: false })) },
                            { name: "Dumbbell Curls", sets: 4, effort: "Moderate (8-12 reps)", rest: "90 seconds", logs: Array.from({ length: 4 }, () => ({ weight: '', reps: '', done: false })) },
                        ],
                        extra: null
                    },
                    wednesday: {
                                    name: "Legs & Abs Day",
                                    exercises: [
                                        { 
                                            name: "Ab Routine (Giant Set)", 
                                            type: "giantSet", 
                                            sets: 3, 
                                            effort: "Hanging Leg Raises -> Hip-ups -> Bicycles -> Crunches",
                                            rest: "60 seconds between rounds", 
                                            // This log structure is new
                                            logs: Array.from({ length: 3 }, () => ({
                                                done: false,
                                                reps: { hangingLegRaises: '', hipUps: '', bicycles: '', crunches: '' }
                                            }))
                                        },
                                        { name: "Barbell Back Squats", sets: 3, effort: "Heavy (5-8 reps)", rest: "2-3 minutes", logs: Array.from({ length: 3 }, () => ({ weight: '', reps: '', done: false })) },
                                        { name: "Romanian Deadlifts", sets: 3, effort: "Moderate (8-12 reps)", rest: "90 seconds", logs: Array.from({ length: 3 }, () => ({ weight: '', reps: '', done: false })) },
                                        { name: "Leg Press or Lunges", sets: 4, effort: "Moderate (10-15 reps)", rest: "90 seconds", logs: Array.from({ length: 4 }, () => ({ weight: '', reps: '', done: false })) },
                                        { name: "Leg Curls", sets: 4, effort: "Moderate (10-15 reps)", rest: "90 seconds", logs: Array.from({ length: 4 }, () => ({ weight: '', reps: '', done: false })) },
                                        { name: "Calf Raises", sets: 5, effort: "Light-to-Moderate (10-20 reps)", rest: "60 seconds", logs: Array.from({ length: 5 }, () => ({ weight: '', reps: '', done: false })) },
                                    ],
                                    extra: null // The old post-workout abs are now removed.
                                },
                    thursday: { name: "Push Day", copy: 'monday' },
                    friday: { name: "Pull Day", copy: 'tuesday' },
                    saturday: { name: "Legs & Abs Day", copy: 'wednesday' },
                };

        
        function parseRepRange(effortString) {
            const match = effortString.match(/\((\d+)-(\d+)/);
            if (match && match[1] && match[2]) {
                return { min: parseInt(match[1]), max: parseInt(match[2]) };
            }
            return null; // Return null if no range is found
        }
        
        function getIncrement(exerciseName) {
            const lowerCaseName = exerciseName.toLowerCase();
            if (lowerCaseName.includes('barbell') || lowerCaseName.includes('squat') || lowerCaseName.includes('deadlift')) {
                return 2.5; // For heavy barbell compound lifts
            } else if (lowerCaseName.includes('dumbbell')) {
                return 2.0; // For dumbbell exercises (1kg per dumbbell)
            } else {
                return 5.0; // A smaller default for machines, cables, etc.
            }
        }
        
        function createInitialState() {
            const state = JSON.parse(JSON.stringify(workoutData)); // Make a deep copy to start
            for (const dayKey in state) {
                const day = state[dayKey];
                if (day.copy) {
                    const sourceDay = state[day.copy];
                    // Create fresh copies of exercises and extra info
                    day.exercises = JSON.parse(JSON.stringify(sourceDay.exercises));
                    day.extra = JSON.parse(JSON.stringify(sourceDay.extra));
                    delete day.copy; // Remove the copy property
                }
            }
            return state;
        }
        
        let appState = {};
        let currentDay = 'monday';
        let allLogs = [];
        let currentWeek = 1;
        let totalWeeks = 1;
        let latestLogMap = new Map();
        
        function precomputeLatestLogs() {
            latestLogMap.clear();
            for (const log of allLogs) {
                // Only consider completed sets for progression
                if (log.Done) {
                    latestLogMap.set(log.Exercise, log);
                }
            }
        }      
        
        async function saveSetData(week, day, exerciseName, setIndex, log) { // Added 'week'
            try {
                // Modify this part to send the whole log object
                const dataToSave = {
                    week: week,
                    day: day,
                    exercise: exerciseName,
                    setIndex: setIndex,
                    log: log
                };

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Important for simple POST requests to Apps Script
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSave)
                });
                console.log("Set saved successfully.");
            } catch (error) {
                console.error("Failed to save set:", error);
            }
        }

function renderWeek(weekNumber) {
            currentWeek = weekNumber;
            const weeklyAppState = createInitialState();
            
            // --- OPTIMIZED PROGRESSIVE OVERLOAD LOGIC ---
            Object.values(weeklyAppState).forEach(dayData => {
                if (!dayData.exercises) return;
                dayData.exercises.forEach(exercise => {
                    // This is now a super-fast lookup instead of a slow loop
                    const lastWorkoutSet = latestLogMap.get(exercise.name);

                    if (lastWorkoutSet) {
                        const repRange = parseRepRange(exercise.effort);
                        let suggestedWeight = parseFloat(lastWorkoutSet.Weight);

                        if (repRange && lastWorkoutSet.Reps >= repRange.max) {
                            const increment = getIncrement(exercise.name);
                            suggestedWeight += increment;
                        }
                        
                        exercise.logs.forEach(log => {
                            log.weight = suggestedWeight;
                        });
                    }
                });
            });
            // --- END OF OPTIMIZED LOGIC ---

            appState = weeklyAppState;
            
            // Repopulate with any data already saved for the current week
            const currentWeekLogs = allLogs.filter(log => log.Week == currentWeek);
            currentWeekLogs.forEach(log => {
                const dayInfo = appState[log.Day];
                if (dayInfo && dayInfo.exercises) {
                    const exercise = dayInfo.exercises.find(ex => ex.name === log.Exercise);
                    if (exercise && exercise.logs[log.SetIndex] !== undefined) {
                        exercise.logs[log.SetIndex] = { weight: log.Weight, reps: log.Reps, done: log.Done };
                    }
                }
            });

            // Update UI (this part remains the same)
            let weekTitle = `Week ${currentWeek}`;
            if (currentWeekLogs.length > 0) {
                const anyDateFromWeek = new Date(currentWeekLogs[0].Timestamp);
                const dayOfWeek = anyDateFromWeek.getDay();
                const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                const weekStartDate = new Date(anyDateFromWeek);
                weekStartDate.setDate(anyDateFromWeek.getDate() - daysToSubtract);
                const weekEndDate = new Date(weekStartDate);
                weekEndDate.setDate(weekStartDate.getDate() + 6);
                const options = { month: 'short', day: 'numeric' };
                const formattedStart = weekStartDate.toLocaleDateString(undefined, options);
                const formattedEnd = weekEndDate.toLocaleDateString(undefined, options);
                weekTitle += ` (${formattedStart} - ${formattedEnd})`;
            }
            
            document.getElementById('subtitle-display').textContent = `Your 8-Week Foundational Block - Week ${currentWeek}`;
            document.getElementById('week-number-display').textContent = `Week ${currentWeek}`;
            document.getElementById('week-date-display').textContent = weekTitle.replace(`Week ${currentWeek} `, '');
            document.getElementById('prev-week-btn').disabled = (currentWeek <= 1);
            document.getElementById('next-week-btn').disabled = (currentWeek >= totalWeeks);
            
            renderWorkout(currentDay);
        }
                
        function handleInteraction(e) {
                    const target = e.target;
                    const setRow = target.closest('.set-row');
                    if (!setRow) return;
        
                    const { exerciseIndex, setIndex } = setRow.dataset;
                    const dayKey = currentDay;
                    const exercise = appState[dayKey].exercises[exerciseIndex];
                    const log = exercise.logs[setIndex];
        
                    // Update state based on input type
                    const dataType = target.dataset.type;
                    if (dataType === "done") {
                        log.done = target.checked;
                        setRow.classList.toggle('completed', log.done);
                    } else if (exercise.type === 'giantSet' && dataType === 'reps') {
                        // Handle reps for the custom ab routine card
                        const abExercise = target.dataset.abExercise;
                        log.reps[abExercise] = target.value;
                    } else {
                        // Handle reps and weight for regular exercises
                        log[dataType] = target.value;
                    }
        
                    // Save data when a round is marked as complete
                    if (dataType === "done") {
                        saveSetData(currentWeek, dayKey, exercise.name, setIndex, log);
                    }
                }
        
        function loadData() {
            // Use the new helper function to create a clean state
            appState = createInitialState();
  
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonpCallback_' + Date.now();
                window[callbackName] = function(logs) {
                    const now = new Date();
                    allLogs = logs.filter(log => new Date(log.Timestamp) <= now);
                    
                    precomputeLatestLogs();
                    
                    if (allLogs.length > 0) {
                        totalWeeks = Math.max(...allLogs.map(log => log.Week || 1));
                    } else {
                        totalWeeks = 1;
                    }
                    currentWeek = totalWeeks;

                    document.body.removeChild(script);
                    delete window[callbackName];
                    resolve(); 
                };
                const script = document.createElement('script');
                script.src = SCRIPT_URL + '?callback=' + callbackName;
                script.onerror = reject;
                document.body.appendChild(script);
            });
        }
        
        function renderWorkout(day) {
            currentDay = day;
            const dayDataToRender = appState[day];
            const workoutContainer = document.getElementById('workout-container');
            workoutContainer.innerHTML = '';
            
            dayDataToRender.exercises.forEach((exercise, exerciseIndex) => {

                if (exercise.type === 'giantSet') {
                    // --- RENDER THE CUSTOM AB ROUTINE CARD ---
                    let setsHtml = '';
                    for (let i = 0; i < exercise.sets; i++) {
                        const log = exercise.logs[i];
                        // --- THIS LAYOUT IS MODIFIED ---
                        setsHtml += `
                            <div class="set-row grid grid-cols-5 gap-x-4 items-center p-2 border-b border-slate-200 ${log.done ? 'completed' : ''}" data-exercise-index="${exerciseIndex}" data-set-index="${i}">
                                <div class="flex flex-col items-center justify-center">
                                    <span class="font-medium text-slate-500">Round ${i + 1}</span>
                                    <input type="checkbox" class="h-5 w-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 mt-2" ${log.done ? 'checked' : ''} data-type="done">
                                </div>
                                
                                <div class="text-center">
                                    <label class="text-xs text-slate-500">Leg Raises</label>
                                    <input type="number" class="w-full rounded-md text-center border-slate-300 shadow-sm" value="${log.reps.hangingLegRaises}" placeholder="reps" data-type="reps" data-ab-exercise="hangingLegRaises">
                                </div>
                                <div class="text-center">
                                    <label class="text-xs text-slate-500">Hip-ups</label>
                                    <input type="number" class="w-full rounded-md text-center border-slate-300 shadow-sm" value="${log.reps.hipUps}" placeholder="reps" data-type="reps" data-ab-exercise="hipUps">
                                </div>
                                <div class="text-center">
                                    <label class="text-xs text-slate-500">Bicycles</label>
                                    <input type="number" class="w-full rounded-md text-center border-slate-300 shadow-sm" value="${log.reps.bicycles}" placeholder="reps" data-type="reps" data-ab-exercise="bicycles">
                                </div>
                                <div class="text-center">
                                    <label class="text-xs text-slate-500">Crunches</label>
                                    <input type="number" class="w-full rounded-md text-center border-slate-300 shadow-sm" value="${log.reps.crunches}" placeholder="reps" data-type="reps" data-ab-exercise="crunches">
                                </div>
                            </div>
                        `;
                    }

                    const exerciseCard = `
                        <div class="bg-white rounded-lg shadow-md overflow-hidden">
                            <div class="bg-slate-50 p-4 border-b border-slate-200">
                                <h3 class="text-xl font-bold text-slate-800">${exercise.name}</h3>
                                <p class="text-sm text-slate-500">Rest: ${exercise.rest}</p>
                            </div>
                            <div>${setsHtml}</div>
                        </div>
                    `;
                    workoutContainer.innerHTML += exerciseCard;

                } else {
                    // --- RENDER A REGULAR EXERCISE CARD (This part is unchanged) ---
                    let setsHtml = '';
                    for (let i = 0; i < exercise.sets; i++) {
                        const log = exercise.logs[i] || { weight: '', reps: '', done: false };
                        setsHtml += `
                            <tr class="set-row ${log.done ? 'completed' : ''}" data-exercise-index="${exerciseIndex}" data-set-index="${i}">
                                <td class="p-2 text-center font-medium text-slate-500">${i + 1}</td>
                                <td class="p-2 text-center text-slate-600">${exercise.effort}</td>
                                <td class="p-2">
                                    <input type="number" class="w-full rounded-md border-slate-300 shadow-sm" value="${log.weight}" placeholder="kg" data-type="weight">
                                </td>
                                <td class="p-2">
                                    <input type="number" class="w-full rounded-md border-slate-300 shadow-sm" value="${log.reps}" placeholder="reps" data-type="reps">
                                </td>
                                <td class="p-2 text-center">
                                    <input type="checkbox" class="h-5 w-5 rounded border-slate-300 text-blue-600" ${log.done ? 'checked' : ''} data-type="done">
                                </td>
                            </tr>
                        `;
                    }
                    const exerciseCard = `
                        <div class="bg-white rounded-lg shadow-md overflow-hidden">
                             <div class="bg-slate-50 p-4 border-b border-slate-200">
                                <h3 class="text-xl font-bold text-slate-800">${exercise.name}</h3>
                                <p class="text-sm text-slate-500">Rest: ${exercise.rest}</p>
                            </div>
                            <div class="p-2">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b border-slate-200">
                                            <th class="p-2 font-semibold text-slate-600 text-sm w-1/12">Set</th>
                                            <th class="p-2 font-semibold text-slate-600 text-sm w-4/12">Target</th>
                                            <th class="p-2 font-semibold text-slate-600 text-sm w-3/12">Weight</th>
                                            <th class="p-2 font-semibold text-slate-600 text-sm w-3/12">Reps</th>
                                            <th class="p-2 font-semibold text-slate-600 text-sm w-1/12">✓</th>
                                        </tr>
                                    </thead>
                                    <tbody>${setsHtml}</tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    workoutContainer.innerHTML += exerciseCard;
                }
            });

            if (dayDataToRender.extra) {
                 let extraContent = `<p class="text-slate-600">${dayDataToRender.extra.details}</p>`;
                 if (dayDataToRender.extra.type === 'Abs') {
                    extraContent = `<ul class="list-disc list-inside text-slate-600 space-y-1">` +
                                   abRoutine.map(ex => `<li><span class="font-semibold">${ex.name}:</span> ${ex.reps}</li>`).join('') +
                                   `</ul>`;
                 }
                const extraCard = `
                    <div class="bg-white rounded-lg shadow-md">
                        <div class="bg-slate-50 p-4 border-b border-slate-200">
                             <h3 class="text-xl font-bold text-slate-800">Post-Workout: ${dayDataToRender.extra.type}</h3>
                        </div>
                        <div class="p-4">${extraContent}</div>
                    </div>
                `;
                workoutContainer.innerHTML += extraCard;
            }

            updateDayTabs();
            addEventListeners();
        }

        function updateDayTabs() {
            const daySelector = document.getElementById('day-selector');
            daySelector.innerHTML = '';
            Object.keys(workoutData).forEach(dayKey => {
                const dayInfo = workoutData[dayKey];
                const button = document.createElement('button');
                button.textContent = `${dayInfo.name} (${dayKey.charAt(0).toUpperCase() + dayKey.slice(1, 3)})`;
                button.className = `day-tab p-2 rounded-md font-semibold text-sm sm:text-base transition-colors duration-200 ${dayKey === currentDay ? 'active' : 'bg-slate-100 hover:bg-slate-200'}`;
                button.dataset.day = dayKey;
                daySelector.appendChild(button);
            });

            daySelector.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    renderWorkout(e.target.dataset.day);
                }
            });
        }
        

        function addEventListeners() {
            const workoutContainer = document.getElementById('workout-container');
            // We REMOVED the 'input' listener to prevent saving on every keystroke.
            workoutContainer.addEventListener('change', handleInteraction);
        }
        
        async function init() {
            await loadData();

            // --- THIS IS THE LOGIC THAT SETS THE DAY ---
            const today = new Date().getDay(); // Gets the current day (Sunday=0, Monday=1, etc.)
            
            // This array maps the day number to your workout keys.
            const dayMap = [
                'saturday',  // Sunday (index 0) will show Saturday's workout
                'monday',    // Monday (index 1)
                'tuesday',   // Tuesday (index 2)
                'wednesday', // Wednesday (index 3)
                'thursday',  // Thursday (index 4)
                'friday',    // Friday (index 5)
                'saturday'   // Saturday (index 6)
            ];

            const todayKey = dayMap[today];
            // --- END OF LOGIC ---

            // Set the initial day tab correctly before rendering
            currentDay = todayKey;

            // Render the page starting with the correct week and day
            renderWeek(currentWeek);

            // Add event listeners for the week buttons
            document.getElementById('prev-week-btn').addEventListener('click', () => {
                if (currentWeek > 1) {
                    renderWeek(currentWeek - 1);
                }
            });
            document.getElementById('next-week-btn').addEventListener('click', () => {
                if (currentWeek < totalWeeks) {
                    renderWeek(currentWeek + 1);
                }
            });
        }

        init();
    </script>
</body>
</html>
