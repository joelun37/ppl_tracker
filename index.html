<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPL Workout Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .day-tab.active { background-color: #3b82f6; color: white; }
        .set-row.completed td { color: #9ca3af; }
        .set-row.completed input { text-decoration: line-through; color: #9ca3af; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto max-w-4xl p-4 sm:p-6">
        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">Foundational PPL Plan</h1>
            <p id="subtitle-display" class="text-slate-500 mt-1">8-Week Foundational Block</p>
        </header>

        <div id="week-nav-container" class="flex justify-between items-center bg-white rounded-lg shadow-md p-3 mb-4">
            <button id="prev-week-btn" class="px-4 py-2 bg-slate-200 rounded-md hover:bg-slate-300 transition-colors">‚óÑ Prev</button>
            <h2 class="text-center">
                <span id="week-number-display" class="text-xl font-bold text-slate-700"></span>
                <span id="week-date-display" class="block text-xs sm:text-sm font-normal text-slate-500 mt-1"></span>
            </h2>
            <button id="next-week-btn" class="px-4 py-2 bg-slate-200 rounded-md hover:bg-slate-300 transition-colors">Next ‚ñ∫</button>
        </div>
                
        <nav class="bg-white rounded-lg shadow-md p-2 mb-6">
            <div id="day-selector" class="grid grid-cols-3 sm:grid-cols-6 gap-2">
                </div>
        </nav>

        <main id="workout-container" class="space-y-6">
            </main>
        
        <footer class="text-center mt-8 text-slate-400 text-sm pb-10">
            <p>Remember to log your lifts!</p>
            <button onclick="localStorage.clear(); window.location.reload()" class="mt-4 text-xs text-red-300 border border-red-200 p-1 rounded">Reset Local Data (Debug)</button>
        </footer>
    </div>

    <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyBlb1ZQxdIl3qRdGErAnxa2i69Y1a16-Btst_lE-gIU4lfYzSR3C8M-ruV6KXRTs1H/exec';

    // --- DATA STRUCTURES ---
    const workoutData = {
        monday: {
            name: "Push Day",
            exercises: [
                { name: "Barbell Bench Press", sets: 3, effort: "Heavy (5-8 reps)", rest: "2-3m", logs: Array(3).fill({ weight: '', reps: '', done: false }) },
                { name: "Seated DB Press", sets: 3, effort: "Mod (8-12 reps)", rest: "90s", logs: Array(3).fill({ weight: '', reps: '', done: false }) },
                { name: "Incline DB Press", sets: 3, effort: "Mod (8-12 reps)", rest: "90s", logs: Array(3).fill({ weight: '', reps: '', done: false }) },
                { name: "DB Lateral Raises", sets: 4, effort: "Light (12-15 reps)", rest: "60s", logs: Array(4).fill({ weight: '', reps: '', done: false }) },
                { name: "Triceps Rope Ext", sets: 4, effort: "Mod (10-15 reps)", rest: "60s", logs: Array(4).fill({ weight: '', reps: '', done: false }) },
            ]
        },
        tuesday: {
            name: "Pull Day",
            exercises: [
                { name: "Pull-ups", sets: 3, effort: "Heavy (6-10 reps)", rest: "2-3m", logs: Array(3).fill({ weight: '', reps: '', done: false }) },
                { name: "Barbell Rows", sets: 3, effort: "Heavy (6-10 reps)", rest: "2-3m", logs: Array(3).fill({ weight: '', reps: '', done: false }) },
                { name: "Face Pulls", sets: 4, effort: "Light (15-20 reps)", rest: "60s", logs: Array(4).fill({ weight: '', reps: '', done: false }) },
                { name: "DB Curls", sets: 4, effort: "Mod (8-12 reps)", rest: "90s", logs: Array(4).fill({ weight: '', reps: '', done: false }) },
            ]
        },
        wednesday: {
            name: "Legs Day",
            exercises: [
                { name: "Barbell Squats", sets: 3, effort: "Heavy (5-8 reps)", rest: "2-3m", logs: Array(3).fill({ weight: '', reps: '', done: false }) },
                { name: "RDLs", sets: 3, effort: "Mod (8-12 reps)", rest: "90s", logs: Array(3).fill({ weight: '', reps: '', done: false }) },
                { name: "Leg Press", sets: 4, effort: "Mod (10-15 reps)", rest: "90s", logs: Array(4).fill({ weight: '', reps: '', done: false }) },
                { name: "Leg Curls", sets: 4, effort: "Mod (10-15 reps)", rest: "90s", logs: Array(4).fill({ weight: '', reps: '', done: false }) },
                { name: "Calf Raises", sets: 5, effort: "Light (15-20 reps)", rest: "60s", logs: Array(5).fill({ weight: '', reps: '', done: false }) },
            ]
        },
        thursday: { name: "Push Day", copy: 'monday' },
        friday: { name: "Pull Day", copy: 'tuesday' },
        saturday: { name: "Legs Day", copy: 'wednesday' },
        sunday: { name: "Rest Day", exercises: [] }
    };

    const travelWorkoutData = {
        name: "Travel / Hotel",
        exercises: [
            { name: "Push-ups", sets: 4, effort: "Failure", logs: Array(4).fill({ weight: 0, reps: '', done: false }) },
            { name: "Bodyweight Squats", sets: 4, effort: "Failure", logs: Array(4).fill({ weight: 0, reps: '', done: false }) },
            { name: "Plank", sets: 4, effort: "Max Hold", logs: Array(4).fill({ weight: 0, reps: '', done: false }) },
            { name: "Glute Bridges", sets: 4, effort: "20 reps", logs: Array(4).fill({ weight: 0, reps: '', done: false }) },
        ]
    };

    // --- STATE MANAGEMENT ---
    let appState = {}; // Holds the current week's inputs (Drafts)
    let dayModes = {}; // Tracks if a day is 'ppl' or 'travel'
    let currentWeek = 1;
    let currentDay = 'monday';
    let allLogs = []; // Historical data from DB
    let latestLogMap = new Map();

    // --- UTILS ---

    function getRealDateForWeek(weekNum) {
        // FIXED: Calculates date based on TODAY, not the DB
        const today = new Date();
        const currentDayOfWeek = today.getDay(); // 0 is Sun
        const msPerDay = 24 * 60 * 60 * 1000;
        
        // Find Monday of the *current real-world week*
        const daysToMonday = currentDayOfWeek === 0 ? 6 : currentDayOfWeek - 1;
        const thisMonday = new Date(today.getTime() - (daysToMonday * msPerDay));
        
        // Adjust for the week number selected in UI (Assuming Week 1 is 'This Week' for PoC simplicity)
        // If you want Week 1 to be in the past, we'd need a "StartDate" setting.
        // For now, let's treat "currentWeek" as relative to the user's start.
        // But to fix the "July" bug, we just return This Week's Monday + offset.
        
        // Actually, simpler approach for PoC: Just show the date range relative to Today.
        // Let's assume Week 1 = This Week.
        const targetMonday = new Date(thisMonday.getTime() + ((weekNum - 1) * 7 * msPerDay));
        const targetSunday = new Date(targetMonday.getTime() + (6 * msPerDay));
        return { start: targetMonday, end: targetSunday };
    }

    function createInitialState() {
        const state = JSON.parse(JSON.stringify(workoutData));
        for (const d in state) {
            if (state[d].copy) {
                state[d].exercises = JSON.parse(JSON.stringify(state[state[d].copy].exercises));
                delete state[d].copy;
            }
        }
        return state;
    }

    // --- PERSISTENCE ---

    function saveLocal() {
        // FIXED: Saves everything to phone memory instantly
        localStorage.setItem('ppl_appState', JSON.stringify(appState));
        localStorage.setItem('ppl_dayModes', JSON.stringify(dayModes));
        localStorage.setItem('ppl_currentWeek', currentWeek);
        localStorage.setItem('ppl_timestamp', new Date().toISOString());
    }

    function loadLocal() {
        const savedState = localStorage.getItem('ppl_appState');
        const savedModes = localStorage.getItem('ppl_dayModes');
        const savedWeek = localStorage.getItem('ppl_currentWeek');

        if (savedState) appState = JSON.parse(savedState);
        else appState = createInitialState();

        if (savedModes) dayModes = JSON.parse(savedModes);
        else Object.keys(workoutData).forEach(d => dayModes[d] = 'ppl');

        if (savedWeek) currentWeek = parseInt(savedWeek);
    }

async function saveToCloud(payload) {
        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' }, // 'text/plain' avoids CORS preflight
                body: JSON.stringify(payload)
            });
            console.log("Sent to cloud");
        } catch (e) {
            console.error("Cloud save failed", e);
        }
    }

    function loadCloudData() {
        return new Promise((resolve) => {
            const callbackName = 'jsonpCallback_' + Date.now();
            window[callbackName] = function(data) {
                allLogs = data;
                // Build a map of the LAST time an exercise was done
                allLogs.forEach(log => {
                    if(log.Done) latestLogMap.set(log.Exercise, log);
                });
                delete window[callbackName];
                document.body.removeChild(script);
                resolve();
            };
            const script = document.createElement('script');
            script.src = SCRIPT_URL + '?callback=' + callbackName;
            script.onerror = resolve; // Continue even if offline
            document.body.appendChild(script);
        });
    }

    // --- LOGIC: PROGRESSIVE OVERLOAD & DELOAD ---

    function applySuggestions() {
        // This runs once when we load the data
        Object.values(appState).forEach(dayData => {
            if (!dayData.exercises) return;
            dayData.exercises.forEach(ex => {
                const lastLog = latestLogMap.get(ex.name);
                
                // Only suggest if the user hasn't typed anything yet
                ex.logs.forEach(log => {
                    if (!log.weight && !log.reps && !log.done && lastLog) {
                        
                        // FIXED: DELOAD LOGIC
                        const daysSince = (new Date() - new Date(lastLog.Timestamp)) / (1000 * 60 * 60 * 24);
                        let weight = parseFloat(lastLog.Weight);
                        
                        if (daysSince > 21) {
                            // 3 weeks off? Drop 20%
                            weight = weight * 0.8;
                        } else if (daysSince > 10) {
                            // 10 days off? Drop 10%
                            weight = weight * 0.9;
                        } else {
                            // Progressive Overload: Add weight if they hit max reps
                            // Simple logic: if they did > 8 reps, add 2.5kg
                            if (parseInt(lastLog.Reps) >= 8) weight += 2.5; 
                        }
                        
                        // Round to nearest 2.5
                        weight = Math.round(weight / 2.5) * 2.5;

                        log.weight = weight;
                        log.reps = lastLog.Reps; // Keep rep target same
                    }
                });
            });
        });
    }

    // --- RENDER ---

    function renderHeader() {
        const { start, end } = getRealDateForWeek(currentWeek);
        const fmt = d => d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
        
        document.getElementById('week-number-display').textContent = `Week ${currentWeek}`;
        document.getElementById('week-date-display').textContent = `${fmt(start)} - ${fmt(end)}`;
        
        document.getElementById('prev-week-btn').disabled = currentWeek <= 1;
        document.getElementById('prev-week-btn').classList.toggle('opacity-50', currentWeek <= 1);
    }

function renderTabs() {
        const container = document.getElementById('day-selector');
        container.innerHTML = '';
        
        Object.keys(workoutData).forEach(day => {
            const isTravel = dayModes[day] === 'travel';
            const isActive = day === currentDay;
            const label = day.substring(0,3).toUpperCase();
            
            const btn = document.createElement('button');
            // Prevent the default iOS long-press menu
            btn.style.userSelect = 'none'; 
            btn.style.webkitUserSelect = 'none';
            
            btn.className = `day-tab-btn relative p-2 rounded-md font-bold text-sm transition-all border select-none ${
                isActive ? 'bg-blue-500 text-white border-blue-600' : 
                isTravel ? 'bg-amber-100 text-amber-800 border-amber-200' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'
            }`;
            
            btn.innerHTML = `
                <div class="pointer-events-none">${label}</div>
                <div class="pointer-events-none text-[10px] font-normal opacity-80">${isTravel ? '‚úàÔ∏è' : workoutData[day].name.split(' ')[0]}</div>
                ${isTravel ? '<div class="absolute -top-1 -right-1 bg-amber-500 text-white text-[8px] px-1 rounded-full">TRAVEL</div>' : ''}
            `;
            
            // --- LOGIC FOR LONG PRESS (IPHONE FIX) ---
            let pressTimer;
            let isLongPress = false;

            // 1. Touch Start: Begin the countdown
            btn.addEventListener('touchstart', (e) => {
                isLongPress = false;
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    // Trigger the toggle
                    dayModes[day] = isTravel ? 'ppl' : 'travel';
                    saveLocal();
                    renderTabs();
                    if(day === currentDay) renderWorkout();
                    
                    // Haptic feedback if available
                    if (navigator.vibrate) navigator.vibrate(50);
                }, 600); // 600ms hold time
            }, {passive: true});

            // 2. Touch End: Clear timer. If it wasn't a long press, do a normal click.
            btn.addEventListener('touchend', (e) => {
                clearTimeout(pressTimer);
                if (!isLongPress) {
                    // Normal tap behavior
                    e.preventDefault(); // Stop ghost clicks
                    currentDay = day; 
                    renderWorkout();
                    renderTabs(); // Re-render to highlight active tab
                }
            });

            // 3. Touch Move: User is scrolling, CANCEL the long press
            btn.addEventListener('touchmove', () => {
                clearTimeout(pressTimer);
            }, {passive: true});

            // 4. Desktop Right Click (Backup)
            btn.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                dayModes[day] = isTravel ? 'ppl' : 'travel';
                saveLocal();
                renderTabs();
                if(day === currentDay) renderWorkout();
            });

            // 5. Desktop Click
            btn.addEventListener('click', () => {
                 // Handled by touchend on mobile, but needed for mouse users
                 if (window.matchMedia('(hover: hover)').matches) {
                    currentDay = day; 
                    renderWorkout();
                    renderTabs();
                 }
            });

            container.appendChild(btn);
        });
        
        // Helper text update
        if(!document.getElementById('hint-added')) {
            const hint = document.createElement('div');
            hint.id = 'hint-added';
            hint.className = "col-span-3 sm:col-span-6 text-center text-[10px] text-slate-400 mt-1";
            hint.textContent = "Tap to view ‚Ä¢ Hold to toggle Travel Mode ‚úàÔ∏è";
            container.appendChild(hint);
        }
    }

    function renderWorkout() {
        const container = document.getElementById('workout-container');
        container.innerHTML = '';

        const isTravel = dayModes[currentDay] === 'travel';
        let data = isTravel ? travelWorkoutData : appState[currentDay];
        
        // If switching to travel for first time, we might need to copy template structure
        if (isTravel && !appState[currentDay + '_travel_data']) {
            appState[currentDay + '_travel_data'] = JSON.parse(JSON.stringify(travelWorkoutData));
        }
        if (isTravel) data = appState[currentDay + '_travel_data'];

        if (!data || !data.exercises || data.exercises.length === 0) {
            container.innerHTML = `<div class="bg-white p-8 rounded-lg shadow text-center text-slate-500">Rest Day üßò</div>`;
            return;
        }

        data.exercises.forEach((ex, exIdx) => {
            const card = document.createElement('div');
            card.className = "bg-white rounded-lg shadow-md overflow-hidden";
            
            let rows = '';
            ex.logs.forEach((log, setIdx) => {
                rows += `
                <tr class="set-row border-b border-slate-100 last:border-0 ${log.done ? 'completed bg-slate-50' : ''}">
                    <td class="p-3 text-center text-slate-400 font-mono text-sm">${setIdx + 1}</td>
                    <td class="p-2 text-xs text-slate-500">${ex.effort}</td>
                    <td class="p-2">
                        <input type="tel" data-type="weight" data-ex="${exIdx}" data-set="${setIdx}" 
                            value="${log.weight}" placeholder="kg" 
                            class="w-full bg-slate-50 border border-slate-200 rounded p-2 text-center font-semibold focus:ring-2 focus:ring-blue-500 outline-none">
                    </td>
                    <td class="p-2">
                        <input type="tel" data-type="reps" data-ex="${exIdx}" data-set="${setIdx}" 
                            value="${log.reps}" placeholder="reps" 
                            class="w-full bg-slate-50 border border-slate-200 rounded p-2 text-center font-semibold focus:ring-2 focus:ring-blue-500 outline-none">
                    </td>
                    <td class="p-3 text-center">
                        <input type="checkbox" data-type="done" data-ex="${exIdx}" data-set="${setIdx}" 
                            ${log.done ? 'checked' : ''} 
                            class="w-6 h-6 text-blue-600 rounded focus:ring-blue-500">
                    </td>
                </tr>`;
            });

            card.innerHTML = `
                <div class="bg-slate-50 p-3 border-b border-slate-200 flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-slate-800">${ex.name}</h3>
                        <p class="text-xs text-slate-500">Rest: ${ex.rest || 'N/A'}</p>
                    </div>
                </div>
                <table class="w-full">
                    <thead class="bg-slate-100 text-xs text-slate-500 uppercase">
                        <tr><th class="p-2 w-8">#</th><th class="p-2">Goal</th><th class="p-2 w-20">Kg</th><th class="p-2 w-20">Reps</th><th class="p-2 w-10">‚úì</th></tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
            container.appendChild(card);
        });
    }

    // --- EVENTS ---

    document.getElementById('workout-container').addEventListener('input', (e) => {
        handleInput(e);
    });
    
    document.getElementById('workout-container').addEventListener('change', (e) => {
        // Handle checkbox specific logic
        if(e.target.type === 'checkbox') handleInput(e);
    });

function handleInput(e) {
        const el = e.target;
        if (!el.dataset.type) return;

        const isTravel = dayModes[currentDay] === 'travel';
        const dataKey = isTravel ? currentDay + '_travel_data' : currentDay;
        const exIdx = el.dataset.ex;
        const setIdx = el.dataset.set;
        
        const log = appState[dataKey].exercises[exIdx].logs[setIdx];

        if (el.dataset.type === 'done') {
            log.done = el.checked;
            el.closest('tr').classList.toggle('completed', log.done);
            
            // IF marked DONE, send to cloud with CORRECT STRUCTURE
            if (log.done) {
                const payload = {
                    week: currentWeek,          // script expects 'week' (lowercase)
                    day: currentDay,            // script expects 'day'
                    exercise: appState[dataKey].exercises[exIdx].name, // script expects 'exercise'
                    setIndex: setIdx,           // script expects 'setIndex'
                    log: {                      // script expects a nested 'log' object
                        weight: log.weight,
                        reps: log.reps,
                        done: true
                    }
                };
                saveToCloud(payload);
            }
        } else {
            log[el.dataset.type] = el.value;
        }

        saveLocal();
    }

    // --- INIT ---

    async function init() {
        // 1. Load Local (Instant)
        loadLocal();
        
        // 2. Set Day to actual today
        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        currentDay = days[new Date().getDay()];
        
        // 3. Render initial view
        renderHeader();
        renderTabs();
        renderWorkout();

        // 4. Fetch Cloud History (Background)
        try {
            await loadCloudData();
            console.log("Cloud data loaded. Applying logic...");
            applySuggestions();
            // Re-render to show suggestions if fields were empty
            renderWorkout(); 
        } catch (e) {
            console.log("Working offline.");
        }
    }
    
    // Navigation
    document.getElementById('prev-week-btn').onclick = () => { if(currentWeek > 1) { currentWeek--; saveLocal(); renderHeader(); }};
    document.getElementById('next-week-btn').onclick = () => { currentWeek++; saveLocal(); renderHeader(); };

    init();

    </script>
</body>
</html>
